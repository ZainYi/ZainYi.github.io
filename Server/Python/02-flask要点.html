<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>flask | Zain Yi</title>
    <meta name="description" content="TO BE A CRACKER">
    <link rel="icon" href="/zain.png">
    
    <link rel="preload" href="/assets/css/0.styles.b40796a8.css" as="style"><link rel="preload" href="/assets/js/app.ac5f1340.js" as="script"><link rel="preload" href="/assets/js/31.acd8dcb2.js" as="script"><link rel="prefetch" href="/assets/js/2.a85795b1.js"><link rel="prefetch" href="/assets/js/3.62ae61e3.js"><link rel="prefetch" href="/assets/js/4.d49f1fb7.js"><link rel="prefetch" href="/assets/js/5.a3fab095.js"><link rel="prefetch" href="/assets/js/6.a8b4a36b.js"><link rel="prefetch" href="/assets/js/7.d7707cfa.js"><link rel="prefetch" href="/assets/js/8.b281fb3a.js"><link rel="prefetch" href="/assets/js/9.b38ddefd.js"><link rel="prefetch" href="/assets/js/10.3e4d325b.js"><link rel="prefetch" href="/assets/js/11.93b41b91.js"><link rel="prefetch" href="/assets/js/12.5a03db1e.js"><link rel="prefetch" href="/assets/js/13.4adfde32.js"><link rel="prefetch" href="/assets/js/14.1a520845.js"><link rel="prefetch" href="/assets/js/15.0aace896.js"><link rel="prefetch" href="/assets/js/16.f6ddf6ab.js"><link rel="prefetch" href="/assets/js/17.1fd21dd6.js"><link rel="prefetch" href="/assets/js/18.edbcb9b9.js"><link rel="prefetch" href="/assets/js/19.41d5bf6f.js"><link rel="prefetch" href="/assets/js/20.3c6ac27e.js"><link rel="prefetch" href="/assets/js/21.48188a46.js"><link rel="prefetch" href="/assets/js/22.fac4b07e.js"><link rel="prefetch" href="/assets/js/23.13e7da9f.js"><link rel="prefetch" href="/assets/js/24.6a4639f9.js"><link rel="prefetch" href="/assets/js/25.9f27d2c0.js"><link rel="prefetch" href="/assets/js/26.b7014163.js"><link rel="prefetch" href="/assets/js/27.5fd2c57d.js"><link rel="prefetch" href="/assets/js/28.6ed5d425.js"><link rel="prefetch" href="/assets/js/29.673b8833.js"><link rel="prefetch" href="/assets/js/30.0c3bf845.js"><link rel="prefetch" href="/assets/js/32.12b1b7d4.js"><link rel="prefetch" href="/assets/js/33.7b731028.js"><link rel="prefetch" href="/assets/js/34.b0a984fc.js"><link rel="prefetch" href="/assets/js/35.33cbd931.js"><link rel="prefetch" href="/assets/js/36.052ca880.js">
    <link rel="stylesheet" href="/assets/css/0.styles.b40796a8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Zain Yi</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/ECMAScript/" class="nav-link">ECMAScript</a></div><div class="nav-item"><a href="/CSS3HTML5/" class="nav-link">CSS3&amp;HTML5</a></div><div class="nav-item"><a href="/Node/" class="nav-link">Node</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">服务端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Server/Java/" class="nav-link">Java 开发</a></li><li class="dropdown-item"><!----> <a href="/Server/Python/" class="nav-link router-link-active">Python 爬虫</a></li></ul></div></div><div class="nav-item"><a href="/Tool/" class="nav-link">Tool</a></div><div class="nav-item"><a href="/HTTP/" class="nav-link">HTTP</a></div><div class="nav-item"><a href="/About/" class="nav-link">博主</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">主页</a></div><div class="nav-item"><a href="/ECMAScript/" class="nav-link">ECMAScript</a></div><div class="nav-item"><a href="/CSS3HTML5/" class="nav-link">CSS3&amp;HTML5</a></div><div class="nav-item"><a href="/Node/" class="nav-link">Node</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title">服务端</span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Server/Java/" class="nav-link">Java 开发</a></li><li class="dropdown-item"><!----> <a href="/Server/Python/" class="nav-link router-link-active">Python 爬虫</a></li></ul></div></div><div class="nav-item"><a href="/Tool/" class="nav-link">Tool</a></div><div class="nav-item"><a href="/HTTP/" class="nav-link">HTTP</a></div><div class="nav-item"><a href="/About/" class="nav-link">博主</a></div> <!----></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading open"><span>flask</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/Server/Python/02-flask%E8%A6%81%E7%82%B9.html#要点" class="sidebar-link">要点</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Server/Python/02-flask%E8%A6%81%E7%82%B9.html#flask-核心" class="sidebar-link">flask 核心</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Server/Python/02-flask%E8%A6%81%E7%82%B9.html#进程和线程" class="sidebar-link">进程和线程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Server/Python/02-flask%E8%A6%81%E7%82%B9.html#进程" class="sidebar-link">进程</a></li><li class="sidebar-sub-header"><a href="/Server/Python/02-flask%E8%A6%81%E7%82%B9.html#线程" class="sidebar-link">线程</a></li><li class="sidebar-sub-header"><a href="/Server/Python/02-flask%E8%A6%81%E7%82%B9.html#多线程" class="sidebar-link">多线程</a></li></ul></li><li><a href="/Server/Python/02-flask%E8%A6%81%E7%82%B9.html#面向对象滥用" class="sidebar-link">面向对象滥用</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Server/Python/02-flask%E8%A6%81%E7%82%B9.html#python-序列化-class-类对象" class="sidebar-link">python 序列化 class 类对象</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/Server/Python/02-flask%E8%A6%81%E7%82%B9.html#flask-sqlacodegen" class="sidebar-link">flask-sqlacodegen</a><ul class="sidebar-sub-headers"></ul></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="flask"><a href="#flask" aria-hidden="true" class="header-anchor">#</a> flask</h1> <h2 id="要点"><a href="#要点" aria-hidden="true" class="header-anchor">#</a> 要点</h2> <ul><li><p>flask 路由遵循最小原型和唯一 URL 原则</p></li> <li><p><code>@app.route()</code> 装饰器控制路由，修饰视图函数</p></li> <li><p><code>app.add_url_rule()</code> 注册路由 e.g <code>app.add_url_rule('/hello', view_func=hello)</code>，但是绝大多数情况都是用装饰器的方式</p></li> <li><p><code>app.run()</code> 参数配置</p> <ul><li>debug 是否开启调试模式 e.g debug=True，生产环境 debug='off'</li> <li>host 服务器主机 e.g host=0.0.0.0</li> <li>port 端口</li></ul></li> <li><p>读取配置 <code>app.config.from_object()</code> config 是继承 dict 字典的子类，配置文件里面的常量必须全大写 'DEBUG' 是个默认参数，默认为 False</p></li> <li><p>为什么用判断 <code>if __name__ == '__main__'</code></p> <ul><li>判断文件是否作为入口文件而不是被其他文件所调用</li> <li>生产环境部署时，一般不会使用 flask 自带的服务器，而是用 nginx+uwsgi 来部署项目，所以入口文件很有可能被其他程序调用，所以要加上这个判断</li></ul></li> <li><p>视图函数是被封装过的函数，与普通函数不同，它会返回与 http 协议相关的一些内容</p> <ul><li>status-code、content-type 等</li> <li>视图函数返回的都是 Response 对象</li> <li>通过 make_response 方法创建 Response 对象，并由视图函数返回</li> <li>视图函数可以直接返回一个元组 <code>return '&lt;h2&gt;Flask&lt;/h2&gt;', 200, 'text/html'</code></li></ul></li> <li><p>requests 与 urllib 对比</p> <ul><li>requests 是第三方包
<ul><li>request 无以下操作</li></ul></li> <li>urllib 内置包
<ul><li>使用 <code>quote()</code> 进行编码</li> <li><code>r.read()</code> 去读取请求的内容，读出来的是字节码</li> <li>使用 <code>str()</code> 解析字节流</li> <li><code>try...catch</code> 做异常处理</li></ul></li></ul></li> <li><p>flask 蓝图</p> <ul><li>blueprint</li> <li>通过蓝图来组装视图函数</li></ul></li> <li><p>flask Request 对象</p> <ul><li>Request</li> <li>使用 wtforms 和 Flask_WTForms 做数据验证</li></ul></li> <li><p>数据库创建表的方式</p> <ul><li>Database First</li> <li>Model First</li> <li>Code First
<ul><li>专注业务模型的设计，而不是专注数据库的设计</li> <li>数据库只是用来存取数据的，表关系应该由业务来决定</li> <li>ORM 对象关系映射 比 Code First 更广</li></ul></li></ul></li> <li><p>python 连接数据库</p> <ul><li>sqlalchemy</li> <li>Flask_SQLAlchemy</li> <li><code>SQLALCHEMY_DATABASE_URI = 'mysql+cymysql://root:123456@localhost:3306/fisher'</code></li> <li><code>SQLALCHEMY_TRACK_MODIFICATIONS = False</code></li></ul></li></ul> <h2 id="flask-核心"><a href="#flask-核心" aria-hidden="true" class="header-anchor">#</a> flask 核心</h2> <ul><li><code>Flask</code> app 核心对象</li> <li><code>Request</code> 请求核心对象</li> <li><code>AppContext</code> 应用上下文
<ul><li>是对 <code>Flask</code> 核心的包装</li></ul></li> <li><code>RequestContext</code> 请求上下文
<ul><li>是对 <code>Request</code> 核心的包装</li> <li>它要入栈会在逻辑上检查对应的 <code>AppContext</code> 是否入栈</li></ul></li> <li><code>request</code> 请求上下文栈顶对象
<ul><li>实际上是根据 <code>name</code> 返回的一个对象</li> <li>通过 <code>LocalProxy()</code> 获取</li></ul></li> <li><code>current_app</code> 应用上下文栈顶对象
<ul><li>实际上返回的是 app 核心对象</li> <li>通过 <code>LocalProxy()</code> 获取</li></ul></li> <li>通过 <code>ctx = app.app_context()</code> 创建一个应用上下文
<ul><li><code>ctx.push()</code> 压栈</li> <li><code>ctx.pop()</code> 弹栈</li></ul></li> <li><code>with</code> 语句，上下文表达式
<ul><li>实现了 <code>__enter__</code> 和 <code>__exit__</code> 方法，就可以使用 <code>with</code> 语句，即实现了上下文协议</li> <li>上下文管理器包含：<code>__enter__</code> 和 <code>__exit__</code></li> <li><code>__exit__</code> 返回 <code>False</code> 则 <code>with</code> 外部会继续抛出异常，<code>True</code> 则不会</li> <li>用处：链接数据库、文件读写</li> <li>一些地方可以替代 <code>try except finally</code></li> <li>as 后面的变量是 <code>__enter__</code> 返回的值</li></ul></li></ul> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">with</span> app<span class="token punctuation">.</span>app_context<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    a <span class="token operator">=</span> current_app
    <span class="token keyword">print</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
    b <span class="token operator">=</span> current_app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'DEBUG'</span><span class="token punctuation">]</span>

<span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>r<span class="token string">'path'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>
  <span class="token keyword">print</span><span class="token punctuation">(</span>f<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token comment"># f.close() 会自动执行</span>
</code></pre></div><p>flask 核心流程图
<img src="/assets/img/002001.cf0df8f1.png" alt="flask核心流程图"></p> <h2 id="进程和线程"><a href="#进程和线程" aria-hidden="true" class="header-anchor">#</a> 进程和线程</h2> <h3 id="进程"><a href="#进程" aria-hidden="true" class="header-anchor">#</a> 进程</h3> <p>计算机资源是有限的，应用程序需要去竞争计算机的资源，而进程是竞争计算机资源的基本单元</p> <p>操作系统如何管理应用程序对计算机的资源进行竞争————进程管理。进程是操作系统用来调度和分配资源的单位。每个应用程序至少一个进程，操作系统调度不同的进程，让他们轮番的使用计算机的进程</p> <p>单核 CPU，同一时刻只能运行一个应用程序，但 CPU 的运算速度足够快（快到感觉不到切换），所以 CPU 可以不同时刻在不同应用程序之间切换运行（进程调度）。进程/线程切换对系统的开销是比较大的，因为要切换应用程序的上下文，不同的应用程序的上下文是不一样的</p> <h3 id="线程"><a href="#线程" aria-hidden="true" class="header-anchor">#</a> 线程</h3> <p>线程是进程的一部分，一个进程可以有一个或者多个线程。CPU 越来越快，进程管理调度的粒度太大，不能高效利用 CPU 的性能，需要一个更小的单元来管理/使用 CPU 的资源，进程的切换非常笨重，所以需要更灵活的线程机制来协调 CPU 资源的利用，线程切换的消化远比进程切换要小。线程与进程最大的区别是分工不同，<strong>进程分配资源，线程利用 CPU 等资源执行代码或程序</strong></p> <h3 id="多线程"><a href="#多线程" aria-hidden="true" class="header-anchor">#</a> 多线程</h3> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> threading

t <span class="token operator">=</span> threading<span class="token punctuation">.</span>current_threading<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 获取当前线程，默认是主线程</span>

new_t <span class="token operator">=</span> threading<span class="token punctuation">.</span>Thread<span class="token punctuation">(</span>target<span class="token operator">=</span>func<span class="token punctuation">,</span> name<span class="token operator">=</span><span class="token string">'thread_name'</span><span class="token punctuation">)</span> <span class="token comment"># 传入子线程执行的目标函数</span>
new_t<span class="token punctuation">.</span>start<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment"># 启动子线程，并不会阻塞主线程里的其他代码执行，只是启动</span>

<span class="token keyword">print</span><span class="token punctuation">(</span>t<span class="token punctuation">.</span>getName<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>优点</p> <ul><li>更加充分的利用 CPU 的性能优势</li> <li>异步编程</li> <li>适合 IO 密集型的程序，查询数据库、请求网络资源、读写文件等</li></ul> <p>缺点</p> <ul><li>python 不能充分利用多核 CPU 的优势，但并不一定是鸡肋</li> <li>GIL 全局解释器锁，决定同一时刻一个 CPU 核上只能执行一个线程，GIL 是为了线程安全</li> <li>严重依赖于 CPU 计算的程序来说，比较鸡肋（CPU 密集型的程序）</li></ul> <p>flask</p> <ul><li>flask 默认是单进程、单线程的</li> <li>通过指定关键参数 <code>threaded=True</code> 开启多线程，<code>processs=2</code> 开启多进程</li> <li>flask 使用了 werkzeug 库来实现线程隔离，里面有一个 Local 对象用来做线程隔离，实际上就是对字典数据结构和线程 id 的封装</li> <li>Local 使用字典的方式实现线程隔离</li> <li>LocalStack 封装了 Local 对象，将其作为自己的一个私有属性，从而实现了线程隔离的栈结构</li> <li>梳理
<ul><li>以线程 ID 号作为 key 的字典 → Local → LocalStack</li> <li>AppContext、RequestContext → LocalStack</li> <li>Flask → AppContext Request → RequestContext</li> <li>current_app → (LocalStack.top = AppContext top.app=Flask)</li> <li>request → (LocalStack.top = RequestContext top.Request=Request)</li></ul></li></ul> <blockquote><p>使用线程隔离的意义：使当前线程能够正确引用到它自己创建的对象，而不是引用到其他线程所创建的对象，这些对象是保存状态的地方</p></blockquote> <h2 id="面向对象滥用"><a href="#面向对象滥用" aria-hidden="true" class="header-anchor">#</a> 面向对象滥用</h2> <ul><li>面向对象应该描述特征（类变量、实例变量）</li> <li>面向对象应该具有行为（方法）</li> <li>只有方法的类，其实是伪装为面向对象的面向过程</li> <li>一个类的方法大量标注了 <code>@classmethod @static</code>，即方法并未使用到任何类变量和实例变量，封装性不太好</li></ul> <h2 id="python-序列化-class-类对象"><a href="#python-序列化-class-类对象" aria-hidden="true" class="header-anchor">#</a> python 序列化 class 类对象</h2> <ul><li>使用 json 模块, <code>json.dumps(obj, default=lambda o:o.__dict__)</code></li> <li>函数式编程转义 json 序列化的代码解释权</li></ul> <h2 id="flask-sqlacodegen"><a href="#flask-sqlacodegen" aria-hidden="true" class="header-anchor">#</a> flask-sqlacodegen</h2> <ul><li><code>pipe flask-sqlacodegen</code></li> <li><code>flask-sqlacodegen mysql+cymysql://root:123456@localhost:3306/dbname --table tablename --outfile pathname</code></li></ul></div> <div class="page-edit"><!----> <!----></div> <!----> </div> <!----></div></div>
    <script src="/assets/js/31.acd8dcb2.js" defer></script><script src="/assets/js/app.ac5f1340.js" defer></script>
  </body>
</html>
